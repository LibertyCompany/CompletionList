<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lightspeed Project Completion List</title>

  <!-- PDF Export Libraries (client-side, works on GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#f8fafc;
      --bg1:#eef2ff;
      --card:#ffffff;
      --stroke: rgba(15,23,42,.10);
      --stroke2: rgba(15,23,42,.16);
      --text:#0f172a;
      --muted: rgba(15,23,42,.72);
      --muted2: rgba(15,23,42,.55);
      --accent:#2563eb;
      --accent2:#7c3aed;
      --good:#16a34a;
      --bad:#e11d48;
      --shadow: 0 14px 40px rgba(2,6,23,.10);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(37,99,235,.16), transparent 55%),
        radial-gradient(800px 520px at 90% 20%, rgba(124,58,237,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(22,163,74,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;

      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    body.landing-center{ align-items:center; }

    .wrap{
      width: min(980px, 100%);
      padding: 26px 18px 64px;
    }
    body.landing-center .wrap{ padding: 18px 18px; }

    .top{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-bottom: 14px;
      text-align:center;
      user-select:none;
    }
    .dot{
      width: 14px; height: 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 6px rgba(37,99,235,.10), 0 0 24px rgba(124,58,237,.14);
    }
    .brandText{
      font-size: 13px;
      margin:0;
      letter-spacing:.8px;
      text-transform: uppercase;
      color: rgba(15,23,42,.75);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin: 0 auto;
    }
    .cardInner{ padding: 22px; text-align:center; }

    .hero{
      padding: 28px 22px;
      border-bottom: 1px solid var(--stroke);
      background:
        radial-gradient(700px 280px at 10% 10%, rgba(37,99,235,.12), transparent 55%),
        radial-gradient(640px 260px at 85% 0%, rgba(124,58,237,.10), transparent 60%),
        rgba(255,255,255,.60);
      text-align:center;
    }
    .heroTitle{
      font-size: 34px;
      line-height: 1.1;
      margin: 0 0 10px 0;
      letter-spacing: -.5px;
    }
    .heroSub{
      margin: 0 auto;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      max-width: 72ch;
    }

    .companyGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
      padding: 18px;
      justify-items: center;
    }
    @media (max-width: 860px){
      .companyGrid{ grid-template-columns: 1fr; }
      .heroTitle{ font-size: 28px; }
    }

    .companyBtn{
      cursor:pointer;
      width: 100%;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.88);
      border-radius: 16px;
      padding: 18px 16px;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
      min-height: 96px;
      box-shadow: 0 10px 26px rgba(2,6,23,.06);
    }
    .companyBtn:hover{
      transform: translateY(-1px);
      border-color: var(--stroke2);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 32px rgba(2,6,23,.10);
    }
    .companyName{
      font-size: 16px;
      margin: 0 0 6px 0;
      letter-spacing:.2px;
    }
    .companyMeta{
      margin:0;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.4;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      text-align:center;
    }
    .titleBlock{ width: 100%; text-align:center; }
    .titleBlock h2{
      margin:0 0 6px 0;
      font-size: 22px;
      letter-spacing:-.2px;
    }
    .titleBlock p{
      margin:0 auto;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
      max-width: 78ch;
    }

    .btnRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn{
      cursor:pointer;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.88);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      display:flex;
      gap: 8px;
      align-items:center;
      transition: border-color .12s ease, background .12s ease, transform .12s ease, box-shadow .12s ease;
      user-select:none;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .btn:hover{
      border-color: var(--stroke2);
      background: rgba(255,255,255,.96);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(2,6,23,.10);
    }
    .btn.danger{
      border-color: rgba(225,29,72,.20);
      background: rgba(225,29,72,.08);
    }
    .btn.danger:hover{
      border-color: rgba(225,29,72,.36);
      background: rgba(225,29,72,.10);
    }
    .btn.good{
      border-color: rgba(22,163,74,.20);
      background: rgba(22,163,74,.08);
    }
    .btn.good:hover{
      border-color: rgba(22,163,74,.36);
      background: rgba(22,163,74,.10);
    }

    .progressWrap{
      margin: 14px auto 18px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,.78);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap: wrap;
      text-align:center;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .bar{
      width: min(560px, 100%);
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(2,6,23,.06);
      border: 1px solid rgba(15,23,42,.08);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--good));
      transition: width .18s ease;
    }
    .progressText{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      white-space: nowrap;
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(2,6,23,.03);
      color: rgba(15,23,42,.86);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items: center;
    }
    .item{
      width: 100%;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      border-radius: var(--radius2);
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      gap: 12px;
      text-align:left;
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }
    .item.completed{
      border-color: rgba(22,163,74,.22);
      background: rgba(22,163,74,.06);
    }
    .check{
      width: 18px; height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(15,23,42,.16);
      background: rgba(2,6,23,.03);
      display:grid;
      place-items:center;
      margin-top: 2px;
      flex: 0 0 auto;
      cursor: pointer;
    }
    .item.completed .check{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.16);
    }
    .check svg{ opacity:0; }
    .item.completed .check svg{ opacity:1; }

    .itemMain{ flex: 1 1 auto; cursor: pointer; }
    .itemText{
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
      color: rgba(15,23,42,.92);
    }
    .item.completed .itemText{
      color: rgba(15,23,42,.62);
      text-decoration: line-through;
      text-decoration-thickness: 1px;
      text-decoration-color: rgba(15,23,42,.25);
    }

    .itemActions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .mini{
      cursor:pointer;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.88);
      color: rgba(15,23,42,.92);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space: nowrap;
      box-shadow: 0 10px 20px rgba(2,6,23,.05);
    }
    .mini:hover{
      transform: translateY(-1px);
      border-color: rgba(15,23,42,.16);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 26px rgba(2,6,23,.08);
    }
    .mini.remove{
      border-color: rgba(225,29,72,.18);
      background: rgba(225,29,72,.08);
    }
    .mini.remove:hover{
      border-color: rgba(225,29,72,.30);
      background: rgba(225,29,72,.10);
    }
    .mini.photo{
      border-color: rgba(37,99,235,.18);
      background: rgba(37,99,235,.08);
    }
    .mini.photo:hover{
      border-color: rgba(37,99,235,.28);
      background: rgba(37,99,235,.10);
    }
    .mini.removePhoto{
      border-color: rgba(225,29,72,.18);
      background: rgba(225,29,72,.08);
    }
    .mini.removePhoto:hover{
      border-color: rgba(225,29,72,.30);
      background: rgba(225,29,72,.10);
    }

    .photoRow{
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .thumb{
      width: 84px;
      height: 84px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(2,6,23,.03);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      cursor: pointer;
    }

    .addBox{
      margin: 14px auto 0;
      border: 1px dashed rgba(15,23,42,.18);
      background: rgba(255,255,255,.78);
      border-radius: 16px;
      padding: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }
    .addBox input{
      flex: 1 1 420px;
      min-width: 220px;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 13px;
      outline:none;
    }
    .addBox input::placeholder{ color: rgba(15,23,42,.45); }

    .footerNote{
      margin-top: 16px;
      color: rgba(15,23,42,.55);
      font-size: 12px;
      line-height: 1.6;
      text-align:center;
    }
    .kbd{
      font-family: var(--mono);
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(2,6,23,.03);
      padding: 2px 8px;
      border-radius: 9px;
      color: rgba(15,23,42,.78);
      font-size: 12px;
    }
    .hide{ display:none !important; }

    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modalOverlay.open{ display:flex; }

    .modalCard{
      width: min(960px, 100%);
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(15,23,42,.14);
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(2,6,23,.22);
      overflow: hidden;
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(15,23,42,.10);
    }
    .modalTitle{
      font-size: 13px;
      color: rgba(15,23,42,.70);
      margin: 0;
    }
    .modalClose{
      cursor:pointer;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .modalImg{
      width: 100%;
      max-height: 78vh;
      object-fit: contain;
      background: rgba(2,6,23,.03);
      display:block;
    }

    /* Offscreen PDF render container */
    .pdfSandbox{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 980px;
      background: #ffffff;
      color: #0f172a;
      padding: 18px;
      z-index: -1;
    }
    .pdfHeader{
      text-align: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(15,23,42,.10);
    }
    .pdfHeader h1{
      font-size: 20px;
      margin: 0 0 6px 0;
      letter-spacing: -.2px;
    }
    .pdfHeader p{
      margin: 0;
      font-size: 12px;
      color: rgba(15,23,42,.70);
    }

    /* PDF specific overrides: make images full width */
    .pdfMode .itemActions,
    .pdfMode .addBox,
    .pdfMode #pdfTip,
    .pdfMode .btnRow,
    .pdfMode .top,
    .pdfMode input,
    .pdfMode button{
      display: none !important;
    }
    .pdfMode .itemMain{ cursor: default; }
    .pdfMode .check{ cursor: default; }
    .pdfMode .thumb{
      width: 100% !important;
      height: auto !important;
      max-height: 560px !important;
      object-fit: contain !important;
      border-radius: 14px !important;
      display: block !important;
    }
    .pdfMode .photoRow{
      width: 100% !important;
      display: block !important;
      margin-top: 10px !important;
    }
  </style>
</head>

<body class="landing-center">
  <div class="wrap">
    <div class="top">
      <div class="dot"></div>
      <p class="brandText">LIGHTSPEED</p>
    </div>

    <!-- LANDING -->
    <section id="landing" class="card">
      <div class="hero">
        <h2 class="heroTitle">Lightspeed Project Completion List</h2>
        <p class="heroSub">Select your company to view and manage your completion checklist.</p>
      </div>

      <div class="companyGrid">
        <button class="companyBtn" data-company="smith">
          <div>
            <p class="companyName">Smith Construction</p>
            <p class="companyMeta">Completion list</p>
          </div>
        </button>

        <button class="companyBtn" data-company="spi">
          <div>
            <p class="companyName">SPI</p>
            <p class="companyMeta">Completion list</p>
          </div>
        </button>

        <button class="companyBtn" data-company="bluestar">
          <div>
            <p class="companyName">Blue star</p>
            <p class="companyMeta">Completion list</p>
          </div>
        </button>
      </div>
    </section>

    <!-- CHECKLIST VIEW -->
    <section id="checklistView" class="card hide" style="margin-top:18px;">
      <div class="cardInner" id="checklistInner">
        <div class="toolbar">
          <div class="titleBlock">
            <h2 id="companyTitle">Company Checklist</h2>
            <p id="companySub">Mark items complete or not complete. Add/remove items and photos as needed.</p>
          </div>

          <div class="btnRow">
            <button class="btn" id="backBtn">‚Üê Back</button>
            <button class="btn good" id="downloadPdfBtn">‚¨á Download PDF</button>
            <button class="btn good" id="markAllBtn">‚úì Mark all complete</button>
            <button class="btn" id="resetChecksBtn">‚Ü∫ Reset checks</button>
            <button class="btn danger" id="resetAllBtn">üóë Reset checklist</button>
          </div>
        </div>

        <div class="progressWrap">
          <div class="bar" aria-label="Progress">
            <div id="barFill"></div>
          </div>
          <div class="progressText">
            <span class="badge" id="progressBadge">0 / 0</span>
            <span id="progressPct">0% complete</span>
          </div>
        </div>

        <div id="list" class="list" aria-live="polite"></div>

        <div class="addBox">
          <input id="newItemInput" type="text" placeholder="Add a new checklist point (press Enter to add)" />
          <button class="btn" id="addItemBtn">Ôºã Add point</button>
        </div>

        <div class="footerNote" id="pdfTip">
          Photos are saved <strong>locally on this device</strong> only (no submissions).
          Click a thumbnail to view full-size. Press <span class="kbd">Esc</span> to close.
        </div>
      </div>
    </section>
  </div>

  <!-- Photo preview modal -->
  <div id="photoModal" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <p class="modalTitle">Photo preview</p>
        <button id="photoModalClose" class="modalClose">Close</button>
      </div>
      <img id="photoModalImg" class="modalImg" alt="Photo preview" />
    </div>
  </div>

  <script>
    const DEFAULTS = {
      smith: { name: "Smith Construction", subtitle: "Completion Checklist", items: [
        "Remove all formwork, shores, reshoring, falsework per engineer‚Äôs sequence.",
        "Patch all tie-holes, form-tie cone holes, chamfer voids; grind off fins; ensure uniform finish.",
        "Verify reshoring durations satisfied (retain pour/strip date logs).",
        "Repair honeycombs, voids, blowouts with approved materials; finish to match adjacent concrete.",
        "Address surface defects (bugholes, fins, small spalls); restore sharp arrises at slab edges/openings.",
        "Treat cold joints as directed; verify no open cracks at joints.",
        "Perform crack survey; epoxy inject or route-and-seal structural cracks.",
        "Correct slab high/low spots impacting drainage or transitions.",
        "Ensure column faces plumb; grout pads sound.",
        "CMU walls: replace/repoint cracked units; confirm full-grout; bond beams/lintels complete.",
        "Confirm ramp slopes; eliminate ponding; feather transitions.",
        "Verify CIP curbs straight; repair chips/spalls.",
        "Stair/elevator openings patched; divider beams installed.",
        "Trench recesses complete; edges sound; dimensions match coordination.",
        "Drains/RWL openings formed correctly; no accidental cores.",
        "Install sealant at slab edges and joints; penetration collars complete.",
        "Remove temporary rails, toe boards, netting; patch anchor holes.",
        "Verify TOS/TOB elevations; provide as-built survey.",
        "Remove curing compounds; clean all structural surfaces.",
        "Compile concrete test reports; close NCRs; deliver as-builts."
      ]},
      spi: { name: "SPI", subtitle: "Completion Checklist", items: [
        "Remove temporary decking sheets, erection angles/kickers, safety tabs.",
        "Remove or grind flush weld tabs, lifting eyes, temporary embed plates; protect bare steel.",
        "Verify bearing lengths; correct short-bearings; log corrections.",
        "Fully grout pockets and shear keys; no voids.",
        "Replace temporary shim packs with permanent shims/grout.",
        "Confirm joist alignment and camber; remedial grind/topping if needed.",
        "Remove temporary anchors; fill holes with epoxy/grout.",
        "Complete and clean field welds; apply touch-up coatings.",
        "Leave undersides/deck soffits free of debris and protrusions."
      ]},
      bluestar: { name: "Blue star", subtitle: "Completion Checklist", items: [
        "Verify all lap splices, hooks, and dowels remain intact after remedial work.",
        "Protect any rebar exposed during patching; re-encase per engineer‚Äôs direction.",
        "Ensure anchor holes near reinforcement are epoxy-filled or grouted.",
        "Provide final reinforcement inspection sign-off.",
        "Submit photo documentation of congestion areas and critical details."
      ]}
    };

    const KEY_PREFIX = "lightspeed_checklist_v1:";
    const landing = document.getElementById("landing");
    const checklistView = document.getElementById("checklistView");
    const listEl = document.getElementById("list");
    const checklistInner = document.getElementById("checklistInner");

    const companyTitleEl = document.getElementById("companyTitle");
    const companySubEl = document.getElementById("companySub");
    const barFill = document.getElementById("barFill");
    const progressBadge = document.getElementById("progressBadge");
    const progressPct = document.getElementById("progressPct");

    const backBtn = document.getElementById("backBtn");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");
    const markAllBtn = document.getElementById("markAllBtn");
    const resetChecksBtn = document.getElementById("resetChecksBtn");
    const resetAllBtn = document.getElementById("resetAllBtn");
    const newItemInput = document.getElementById("newItemInput");
    const addItemBtn = document.getElementById("addItemBtn");

    let activeCompanyId = null;
    let activeState = null;

    function setLandingCentered(isCentered){
      document.body.classList.toggle("landing-center", isCentered);
    }

    function storageKey(companyId){ return KEY_PREFIX + companyId; }
    function loadCompanyState(companyId){
      const raw = localStorage.getItem(storageKey(companyId));
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveCompanyState(companyId, state){
      localStorage.setItem(storageKey(companyId), JSON.stringify(state));
    }
    function cryptoRandomId(seed){
      try{
        const arr = new Uint32Array(2);
        crypto.getRandomValues(arr);
        return seed + "_" + arr[0].toString(16) + arr[1].toString(16);
      }catch{
        return seed + "_" + Math.random().toString(16).slice(2);
      }
    }
    function makeDefaultState(companyId){
      const base = DEFAULTS[companyId];
      return {
        companyId,
        items: base.items.map((text, idx) => ({
          id: cryptoRandomId(companyId + "_" + idx),
          text,
          done: false
        }))
      };
    }

    // IndexedDB photo storage (local device)
    const DB_NAME = "lightspeed_photos_db";
    const DB_STORE = "photos";

    function openPhotoDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DB_STORE)){
            db.createObjectStore(DB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function setPhoto(key, dataUrl){
      const db = await openPhotoDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, "readwrite");
        tx.objectStore(DB_STORE).put(dataUrl, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function getPhoto(key){
      const db = await openPhotoDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, "readonly");
        const req = tx.objectStore(DB_STORE).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function deletePhoto(key){
      const db = await openPhotoDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, "readwrite");
        tx.objectStore(DB_STORE).delete(key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    function photoKey(companyId, itemId){
      return `photo:${companyId}:${itemId}`;
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    // Modal preview
    const photoModal = document.getElementById("photoModal");
    const photoModalImg = document.getElementById("photoModalImg");
    const photoModalClose = document.getElementById("photoModalClose");

    function openPhotoModal(src){
      photoModalImg.src = src;
      photoModal.classList.add("open");
    }
    function closePhotoModal(){
      photoModal.classList.remove("open");
      photoModalImg.src = "";
    }
    photoModalClose.addEventListener("click", closePhotoModal);
    photoModal.addEventListener("click", (e) => {
      if (e.target === photoModal) closePhotoModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closePhotoModal();
    });

    function goHome(){
      window.location.hash = "";
      activeCompanyId = null;
      activeState = null;

      checklistView.classList.add("hide");
      landing.classList.remove("hide");

      setLandingCentered(true);
    }

    function openCompany(companyId){
      if (!DEFAULTS[companyId]) return;

      activeCompanyId = companyId;
      activeState = loadCompanyState(companyId) ?? makeDefaultState(companyId);
      saveCompanyState(companyId, activeState);

      landing.classList.add("hide");
      checklistView.classList.remove("hide");

      setLandingCentered(false);

      companyTitleEl.textContent = DEFAULTS[companyId].name + " ‚Äî Completion List";
      companySubEl.textContent = DEFAULTS[companyId].subtitle;

      render();
    }

    function onHashChange(){
      const hash = window.location.hash.replace("#", "").trim();
      if (!hash){ goHome(); return; }

      const params = new URLSearchParams(hash);
      const companyId = params.get("company");
      if (companyId && DEFAULTS[companyId]) openCompany(companyId);
      else goHome();
    }
    window.addEventListener("hashchange", onHashChange);

    async function render(){
      if (!activeState) return;

      listEl.innerHTML = "";

      for (const item of activeState.items){
        const row = document.createElement("div");
        row.className = "item" + (item.done ? " completed" : "");

        const check = document.createElement("div");
        check.className = "check";
        check.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 20 20" fill="none" aria-hidden="true">
            <path d="M16.5 6.5L8.25 14.75L3.5 10" stroke="#0f172a" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;

        const main = document.createElement("div");
        main.className = "itemMain";

        const p = document.createElement("p");
        p.className = "itemText";
        p.textContent = item.text;
        main.appendChild(p);

        const photoRow = document.createElement("div");
        photoRow.className = "photoRow";
        main.appendChild(photoRow);

        const saved = await getPhoto(photoKey(activeCompanyId, item.id));
        if (saved){
          const img = document.createElement("img");
          img.className = "thumb";
          img.src = saved;
          img.alt = "Attached photo";
          img.addEventListener("click", (e) => {
            e.stopPropagation();
            openPhotoModal(img.src);
          });
          photoRow.appendChild(img);
        }

        const actions = document.createElement("div");
        actions.className = "itemActions";

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "mini";
        toggleBtn.textContent = item.done ? "Mark not completed" : "Mark completed";
        toggleBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleItem(item.id); });

        const photoBtn = document.createElement("button");
        photoBtn.className = "mini photo";
        photoBtn.textContent = "üì∑ Add photo";

        const removePhotoBtn = document.createElement("button");
        removePhotoBtn.className = "mini removePhoto";
        removePhotoBtn.textContent = "Remove photo";
        removePhotoBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          await deletePhoto(photoKey(activeCompanyId, item.id));
          await render();
        });

        const removeBtn = document.createElement("button");
        removeBtn.className = "mini remove";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", (e) => { e.stopPropagation(); removeItem(item.id); });

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.capture = "environment";
        fileInput.style.display = "none";

        photoBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          fileInput.click();
        });

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files?.[0];
          if (!file) return;

          const tempUrl = URL.createObjectURL(file);
          let img = photoRow.querySelector("img.thumb");
          if (!img){
            img = document.createElement("img");
            img.className = "thumb";
            img.alt = "Attached photo";
            img.addEventListener("click", (e) => {
              e.stopPropagation();
              openPhotoModal(img.src);
            });
            photoRow.appendChild(img);
          }
          img.src = tempUrl;

          const dataUrl = await fileToDataUrl(file);
          await setPhoto(photoKey(activeCompanyId, item.id), dataUrl);

          URL.revokeObjectURL(tempUrl);
          fileInput.value = "";
        });

        actions.appendChild(toggleBtn);
        actions.appendChild(photoBtn);
        actions.appendChild(removePhotoBtn);
        actions.appendChild(removeBtn);
        actions.appendChild(fileInput);

        check.addEventListener("click", (e) => { e.stopPropagation(); toggleItem(item.id); });
        main.addEventListener("click", () => toggleItem(item.id));

        row.appendChild(check);
        row.appendChild(main);
        row.appendChild(actions);

        listEl.appendChild(row);
      }

      updateProgress();
    }

    function updateProgress(){
      const total = activeState.items.length;
      const done = activeState.items.reduce((acc, it) => acc + (it.done ? 1 : 0), 0);
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);

      barFill.style.width = pct + "%";
      progressBadge.textContent = `${done} / ${total}`;
      progressPct.textContent = `${pct}% complete`;
    }

    function toggleItem(id){
      const idx = activeState.items.findIndex(i => i.id === id);
      if (idx === -1) return;
      activeState.items[idx].done = !activeState.items[idx].done;
      saveCompanyState(activeCompanyId, activeState);
      render();
    }

    function removeItem(id){
      const idx = activeState.items.findIndex(i => i.id === id);
      if (idx === -1) return;

      deletePhoto(photoKey(activeCompanyId, id)).catch(() => {});
      activeState.items.splice(idx, 1);
      saveCompanyState(activeCompanyId, activeState);
      render();
    }

    function addItem(text){
      const t = (text ?? "").trim();
      if (!t) return;

      activeState.items.push({
        id: cryptoRandomId(activeCompanyId + "_custom"),
        text: t,
        done: false
      });
      saveCompanyState(activeCompanyId, activeState);
      render();
    }

    function markAllComplete(){
      activeState.items.forEach(i => i.done = true);
      saveCompanyState(activeCompanyId, activeState);
      render();
    }

    function resetChecks(){
      activeState.items.forEach(i => i.done = false);
      saveCompanyState(activeCompanyId, activeState);
      render();
    }

    function resetAll(){
      Promise.all(activeState.items.map(it => deletePhoto(photoKey(activeCompanyId, it.id)).catch(() => {})))
        .finally(() => {
          activeState = makeDefaultState(activeCompanyId);
          saveCompanyState(activeCompanyId, activeState);
          render();
        });
    }

    // PDF Export with FULL-SIZED photos
    function pad2(n){ return String(n).padStart(2, "0"); }
    function formatDateTime(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function safeFileStamp(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    }

    async function downloadPdfReport(){
      if (!activeCompanyId || !activeState) return;

      const now = new Date();
      const companyName = DEFAULTS[activeCompanyId].name;
      const total = activeState.items.length;
      const done = activeState.items.reduce((acc, it) => acc + (it.done ? 1 : 0), 0);
      const pct = total === 0 ? 0 : Math.round((done/total)*100);

      const sandbox = document.createElement("div");
      sandbox.className = "pdfSandbox pdfMode";

      sandbox.innerHTML = `
        <div class="pdfHeader">
          <h1>Lightspeed Project Completion Report</h1>
          <p><strong>Company:</strong> ${companyName} &nbsp; | &nbsp; <strong>Date:</strong> ${formatDateTime(now)} &nbsp; | &nbsp; <strong>Progress:</strong> ${done}/${total} (${pct}%)</p>
        </div>
      `;

      // Clone the list only (not buttons)
      const listClone = listEl.cloneNode(true);

      // Ensure thumbnails become "full width" in sandbox
      // (CSS .pdfMode overrides do the sizing)
      sandbox.appendChild(listClone);

      document.body.appendChild(sandbox);

      const canvas = await html2canvas(sandbox, {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true
      });

      sandbox.remove();

      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "a4"
      });

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const margin = 24;
      const usableWidth = pageWidth - margin * 2;

      const imgWidth = usableWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let y = margin;

      pdf.addImage(imgData, "PNG", margin, y, imgWidth, imgHeight);
      heightLeft -= (pageHeight - margin * 2);

      while (heightLeft > 0) {
        pdf.addPage();
        y = margin - (imgHeight - heightLeft);
        pdf.addImage(imgData, "PNG", margin, y, imgWidth, imgHeight);
        heightLeft -= (pageHeight - margin * 2);
      }

      const fileName = `Lightspeed_Completion_Report_${companyName.replace(/\s+/g,"_")}_${safeFileStamp(now)}.pdf`;
      pdf.save(fileName);
    }

    document.querySelectorAll(".companyBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const companyId = btn.getAttribute("data-company");
        window.location.hash = `company=${encodeURIComponent(companyId)}`;
      });
    });

    backBtn.addEventListener("click", goHome);
    downloadPdfBtn.addEventListener("click", downloadPdfReport);
    markAllBtn.addEventListener("click", markAllComplete);
    resetChecksBtn.addEventListener("click", resetChecks);
    resetAllBtn.addEventListener("click", resetAll);

    addItemBtn.addEventListener("click", () => {
      addItem(newItemInput.value);
      newItemInput.value = "";
      newItemInput.focus();
    });

    newItemInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        addItem(newItemInput.value);
        newItemInput.value = "";
      }
    });

    onHashChange();
  </script>
</body>
</html>
